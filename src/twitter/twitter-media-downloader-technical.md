# Twitter Media Downloader - Technical Documentation

> **âš ï¸ AI-Generated Content Disclaimer**
>
> This document was generated by Claude Code AI following system research and online web searches. While efforts have been made to ensure accuracy, AI-generated content can contain errors or outdated information. Please verify critical details and test recommendations in a safe environment before applying them to production systems.

---

## Overview

The Twitter Media Downloader is a userscript that enables one-click downloading of videos and images from Twitter (now X) posts. It injects download buttons into tweet action bars, fetches media metadata via Twitter's internal API, and provides customizable filename patterns with advanced features like history tracking and multi-threaded downloads.

**Script:** `twitter_media_downloader.js`
**Version:** 1.06
**Author:** AMANE
**Source:** Based on community userscripts

---

## Table of Contents

- [How It Works](#how-it-works)
- [Architecture](#architecture)
- [Technical Details](#technical-details)
- [Features](#features)
- [Security Analysis](#security-analysis)
- [Data Flow](#data-flow)
- [Code Walkthrough](#code-walkthrough)

---

## How It Works

The script operates in three main phases:

### Phase 1: Initialization

The script initializes on page load by registering a settings menu command and setting up DOM observation:

```javascript
TMD.init = async function () {
    GM_registerMenuCommand(this.language[navigator.language] || this.language.en).settings, this.settings);
    document.head.insertAdjacentHTML('beforeend', '<style>' + this.css + '</style>');
    // ... language detection, history loading, etc.
};
```

### Phase 2: DOM Injection

A MutationObserver watches for new tweets and injects download buttons:

```javascript
new MutationObserver(ms => ms.forEach(m => m.addedNodes.forEach(node => {
    let article = node.tagName == 'ARTICLE' && node || /* ... */;
    if (article && !article.dataset.injected) TMD.inject(article);
}))).observe(document.body, {childList: true, subtree: true});
```

### Phase 3: Media Download

When a download button is clicked, the script:

1. Extracts the tweet status ID from the URL
2. Fetches tweet metadata using Twitter's internal API
3. Parses media URLs (videos/photos)
4. Downloads files with customizable filenames
5. Tracks download history

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TWITTER WEBSITE                              â”‚
â”‚  (twitter.com, mobile.twitter.com, tweetdeck.twitter.com)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Initialization                                                   â”‚
â”‚  â†’ GM_registerMenuCommand for settings                           â”‚
â”‚  â†’ Load language, history, and preferences                       â”‚
â”‚  â†’ Insert custom CSS styling                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MutationObserver for Tweet Detection                            â”‚
â”‚  â†’ Watches for new ARTICLE elements (tweets)                     â”‚
â”‚  â†’ Calls TMD.inject() for each new tweet                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Button Injection (TMD.inject)                                   â”‚
â”‚  â†’ Finds media elements (images/videos) in tweet                 â”‚
â”‚  â†’ Clones existing action button (like/reply/etc.)               â”‚
â”‚  â†’ Adds custom download button with SVG icon                     â”‚
â”‚  â†’ Attaches click handler for download logic                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼ (user clicks download)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Media Discovery (TMD.click)                                     â”‚
â”‚  â†’ Extract status_id from tweet URL                              â”‚
â”‚  â†’ Fetch tweet JSON via internal API                             â”‚
â”‚  â†’ Parse extended_entities.media for URLs                        â”‚
â”‚  â†’ Select highest quality video or photo URL                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Filename Generation                                              â”‚
â”‚  â†’ Replace template variables {user-name}, {status-id}, etc.     â”‚
â”‚  â†’ Sanitize for filesystem compatibility                          â”‚
â”‚  â†’ Handle multiple media per tweet (numbered suffixes)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Multi-threaded Download Queue                                   â”‚
â”‚  â†’ Enqueue downloads with retry logic                            â”‚
â”‚  â†’ Limit concurrent downloads to 2 threads                       â”‚
â”‚  â†’ Show progress in floating notifier                            â”‚
â”‚  â†’ Handle failures and retries automatically                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  History Tracking                                                â”‚
â”‚  â†’ Store downloaded status_ids persistently                      â”‚
â”‚  â†’ Show completion status on buttons                             â”‚
â”‚  â†’ Prevent duplicate downloads                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Settings Panel                                                  â”‚
â”‚  â†’ Custom filename pattern editor                                â”‚
â”‚  â†’ History management (save/clear)                               â”‚
â”‚  â†’ Sensitive content display toggle                              â”‚
â”‚  â†’ Clickable template tags for pattern building                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Technical Details

### Permissions Explained

| Permission | Purpose | Why Required |
|------------|---------|--------------|
| `GM_registerMenuCommand` | Add settings menu | Allows users to access configuration |
| `GM_setValue` | Store preferences | Save filename pattern, history, sensitive content setting |
| `GM_getValue` | Read preferences | Load saved settings on initialization |
| `GM_download` | Download files | Core functionality for media downloads |
| `@match twitter.com/*` | Run on Twitter | Target the main Twitter website |
| `@match mobile.twitter.com/*` | Run on mobile Twitter | Support mobile interface |
| `@match tweetdeck.twitter.com/*` | Run on TweetDeck | Support TweetDeck interface |
| `@compatible Chrome/Firefox` | Browser support | Tested on major browsers |

### API Usage

The script uses Twitter's internal API endpoint:

```
GET /i/api/2/timeline/conversation/{status_id}.json?tweet_mode=extended&include_entities=false&include_user_entities=false
```

**Headers required:**
- `authorization`: Bearer token (hardcoded in script)
- `x-twitter-active-user`: 'yes'
- `x-twitter-client-language`: Language from cookies
- `x-csrf-token`: CSRF token from cookies
- `x-guest-token`: Guest token (if not logged in)

**Response structure:**
```json
{
  "globalObjects": {
    "tweets": {
      "{status_id}": {
        "user_id_str": "12345",
        "full_text": "Tweet text...",
        "extended_entities": {
          "media": [
            {
              "type": "photo|video|animated_gif",
              "media_url": "https://pbs.twimg.com/media/...",
              "video_info": {
                "variants": [
                  {"content_type": "video/mp4", "url": "...", "bitrate": 1280000}
                ]
              }
            }
          ]
        }
      }
    },
    "users": {
      "12345": {"screen_name": "username", "name": "Display Name"}
    }
  }
}
```

### Filename Template System

The script supports customizable filename patterns with template variables:

**Available tags:**
- `{user-name}`: Display name of tweet author
- `{user-id}`: @username of tweet author  
- `{status-id}`: Tweet ID (18-19 digit number)
- `{date-time}`: Tweet creation time (configurable format)
- `{date-time-local}`: Local time zone version
- `{full-text}`: Tweet text content
- `{file-type}`: Media type (photo/video/gif)
- `{file-name}`: Original filename from URL
- `{file-ext}`: File extension

**Default pattern:**
```
twitter_{user-name}(@{user-id})_{date-time}_{status-id}_{file-type}
```

**Example output:**
```
twitter_John Doe(@johndoe)_20231231-235959_1234567890123456789_photo.jpg
```

### Multi-threading and Queue Management

The downloader uses a sophisticated queue system:

```javascript
const downloader = {
  add: function (task) { /* enqueue */ },
  next: async function () { /* process next */ },
  start: function (task) { /* execute download */ },
  retry: function (task, result) { /* handle failures */ },
  update: function() { /* update UI */ }
};
```

**Features:**
- **Thread limit**: Maximum 2 concurrent downloads
- **Retry logic**: Up to 2 retries per failed download
- **Dynamic throttling**: Reduces to 1 thread after 3 failures
- **Progress tracking**: Floating notifier shows active/completed/failed counts
- **Cancellation**: Failed downloads don't block the queue

### DOM Selectors and Injection

**Tweet detection:**
```javascript
let media_selector = [
  'a[href*="/photo/1"]',           // Photo links
  'div[role="progressbar"]',       // Video progress bars
  'div[data-testid="playButton"]', // Video play buttons
  'a[href="/settings/content_you_see"]', // Hidden content
  'div.media-image-container',     // TweetDeck images
  'div.media-preview-container',   // TweetDeck videos
  'div[aria-labelledby]>div:first-child>div[role="button"][tabindex="0"]' // Audio
];
```

**Button placement:**
- Finds existing action buttons (reply/retweet/like/bookmark)
- Clones the last button in the action group
- Inserts download button before the share button
- Special handling for TweetDeck vs. main Twitter UI

### Language Support

Multi-language support with translations:

```javascript
language: {
  en: { download: 'Download', completed: 'Download Completed', /* ... */ },
  ja: { download: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', completed: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†', /* ... */ },
  zh: { download: 'ä¸‹è½½', completed: 'ä¸‹è½½å®Œæˆ', /* ... */ },
  'zh-Hant': { download: 'ä¸‹è¼‰', completed: 'ä¸‹è¼‰å®Œæˆ', /* ... */ }
}
```

---

## Features

### One-Click Downloads
- **Single media**: Direct download button on tweets with media
- **Multiple media**: Individual buttons for each photo in multi-image tweets
- **Video quality**: Automatically selects highest bitrate MP4 variant
- **Photo formats**: Downloads original quality images

### Customizable Filenames
- **Template system**: Flexible pattern with 10+ variables
- **Filesystem safe**: Automatic sanitization of special characters
- **Unicode handling**: Proper escaping for international usernames/text
- **Length limits**: Truncation of very long tweet text

### History Tracking
- **Persistent storage**: Remembers downloaded tweets across sessions
- **Visual feedback**: Completed tweets show "Download Completed" status
- **Duplicate prevention**: Won't re-download already downloaded media
- **Clear option**: Settings panel allows history reset

### Advanced Download Management
- **Queue system**: Up to 2 concurrent downloads to avoid overwhelming browser
- **Retry logic**: Automatic retries for failed downloads
- **Progress indication**: Floating counter shows active downloads
- **Error handling**: Graceful failure with status updates

### Settings Panel
- **Filename editor**: Live preview of custom patterns
- **Template tags**: Clickable buttons to insert variables
- **History controls**: Save/clear download history
- **Sensitive content**: Option to auto-show sensitive media
- **Language detection**: Automatic UI language based on browser locale

### Cross-Platform Support
- **Twitter Web**: Main twitter.com interface
- **Mobile Twitter**: mobile.twitter.com interface  
- **TweetDeck**: tweetdeck.twitter.com interface
- **Browser compatibility**: Chrome and Firefox tested

### UI Integration
- **Native styling**: Download buttons match Twitter's design
- **Hover effects**: Visual feedback on button interaction
- **Loading states**: Animated spinner during downloads
- **Status colors**: Green for completed, red for failed

---

## Security Analysis

### Risk Assessment

| Concern | Severity | Details |
|---------|----------|---------|
| API token usage | âš ï¸ Medium | Uses hardcoded Bearer token for Twitter API access |
| Cookie access | âš ï¸ Medium | Reads CSRF tokens and language preferences from cookies |
| GM_download | ðŸ”¶ Low | Standard userscript permission for file downloads |
| DOM manipulation | ðŸ”¶ Low | Only adds download buttons and styling |

### What the Script Does NOT Do

- âŒ Send data to external servers (only downloads from Twitter)
- âŒ Access authentication tokens beyond required API headers
- âŒ Modify tweet content or interactions
- âŒ Store sensitive user data
- âŒ Make unauthorized API calls

### What It DOES Access

- âœ… Reads tweet metadata via Twitter's public API
- âœ… Downloads media files from `pbs.twimg.com`
- âœ… Stores download history locally using `GM_getValue`
- âœ… Modifies DOM to add download UI elements
- âœ… Reads browser cookies for API authentication

### Trust Considerations

The script requires access to Twitter's internal API:

1. **API token validity** - Twitter may change tokens requiring updates
2. **Rate limiting** - Excessive downloads may trigger Twitter's limits
3. **Terms of service** - Bulk downloading may violate Twitter's ToS

---

## Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Twitter Website                          â”‚
â”‚  (twitter.com, mobile.twitter.com, tweetdeck.twitter.com)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TMD.init() - Initialization                                     â”‚
â”‚  â†’ Register settings menu command                               â”‚
â”‚  â†’ Load preferences and history                                 â”‚
â”‚  â†’ Insert custom CSS                                             â”‚
â”‚  â†’ Start DOM observation                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MutationObserver detects new tweets                            â”‚
â”‚  â†’ Finds ARTICLE elements with media                            â”‚
â”‚  â†’ Calls TMD.inject(article) for each tweet                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TMD.inject(article) - Button Injection                         â”‚
â”‚  â†’ Locate media elements in tweet                               â”‚
â”‚  â†’ Clone existing action button                                 â”‚
â”‚  â†’ Add download icon and styling                                â”‚
â”‚  â†’ Attach click handler                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼ (user clicks download button)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TMD.click(button, status_id, is_exist)                         â”‚
â”‚  â†’ Set loading state                                             â”‚
â”‚  â†’ Load filename template                                        â”‚
â”‚  â†’ Fetch tweet JSON via API                                      â”‚
â”‚  â†’ Parse media URLs from response                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Media Processing                                                â”‚
â”‚  â†’ For each media item:                                          â”‚
â”‚     - Extract URL (highest quality video/photo)                  â”‚
â”‚     - Generate filename from template                            â”‚
â”‚     - Sanitize for filesystem                                    â”‚
â”‚     - Queue download task                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Download Queue Processing                                       â”‚
â”‚  â†’ Add task to downloader queue                                  â”‚
â”‚  â†’ Process up to 2 concurrent downloads                          â”‚
â”‚  â†’ Handle retries for failures                                   â”‚
â”‚  â†’ Update progress notifier                                      â”‚
â”‚  â†’ Mark completion in history                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GM_download() Execution                                         â”‚
â”‚  â†’ Download file to user's download folder                       â”‚
â”‚  â†’ Call success/error callbacks                                  â”‚
â”‚  â†’ Update button status and history                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Settings Panel (GM_registerMenuCommand)                         â”‚
â”‚  â†’ Create overlay dialog                                         â”‚
â”‚  â†’ Show filename pattern editor                                  â”‚
â”‚  â†’ Display history controls                                      â”‚
â”‚  â†’ Handle save/clear operations                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Code Walkthrough

### Main Structure

The script uses an immediately invoked function expression (IIFE) with a global `TMD` object:

```javascript
const TMD = (function () {
  let lang, host, history, show_sensitive, is_tweetdeck;
  return {
    init: function() { /* ... */ },
    inject: function(article) { /* ... */ },
    click: function(btn, status_id, is_exist) { /* ... */ },
    // ... more methods
  };
})();
```

### Key Functions

| Function | Purpose |
|----------|---------|
| `init()` | Initialize script, register menu, load preferences |
| `inject(article)` | Add download buttons to tweet articles |
| `click(btn, status_id, is_exist)` | Handle download button clicks |
| `status(btn, css, title, style)` | Update button visual state |
| `settings()` | Create and show settings panel |
| `fetchJson(status_id)` | Fetch tweet metadata from Twitter API |
| `getCookie(name)` | Extract cookies for API authentication |
| `storage(value)` | Persistently store download history |
| `formatDate(i, o, tz)` | Format timestamps for filenames |
| `downloader.*` | Multi-threaded download queue management |
| `language.*` | Multi-language UI strings |

### Initialization Process

```javascript
(async function() {
  await TMD.init();
  new MutationObserver(/* ... */).observe(document.body, {childList: true, subtree: true});
})();
```

### Tweet Injection Logic

```javascript
inject: function (article) {
  let media = article.querySelector(media_selector.join(','));
  if (media) {
    let status_id = /* extract from URL */;
    let btn_group = /* find action buttons */;
    let btn_down = btn_share.cloneNode(true);
    // Customize button appearance
    btn_down.onclick = () => this.click(btn_down, status_id, is_exist);
    btn_group.insertBefore(btn_down, btn_share.nextSibling);
  }
}
```

### Download Execution

```javascript
click: async function (btn, status_id, is_exist, index) {
  this.status(btn, 'loading');
  let json = await this.fetchJson(status_id);
  let tweet = json.globalObjects.tweets[status_id];
  let user = json.globalObjects.users[tweet.user_id_str];
  
  // Process media
  let medias = tweet.extended_entities?.media;
  if (index) medias = [medias[index - 1]];
  
  medias.forEach(media => {
    let info = this.buildFilenameInfo(tweet, user, media);
    this.downloader.add({
      url: media.type === 'photo' ? media.media_url + ':orig' : /* video URL */,
      name: info.out,
      onload: () => { /* success */ },
      onerror: () => { /* failure */ }
    });
  });
}
```

### Error Handling

```javascript
downloader: {
  retry: function (task, result) {
    retry += 1;
    if (retry == 3) max_thread = 1; // Throttle on failures
    if (task.retry >= max_retry || result.details?.current == 'USER_CANCELED') {
      task.onerror(result);
    } else {
      this.add(task); // Retry
    }
  }
}
```

---

## Troubleshooting

### Download Button Not Appearing

1. **Check tweet has media** - Only tweets with images/videos get buttons
2. **Verify DOM selectors** - Twitter may have changed their HTML structure
3. **Check permissions** - Ensure userscript manager has proper access

### Downloads Failing

1. **API authentication** - Twitter may have changed Bearer token or headers
2. **Rate limiting** - Too many downloads may trigger Twitter's limits
3. **Cookie issues** - CSRF token or guest token may be invalid

### Settings Not Saving

1. **GM_setValue permission** - Ensure userscript manager allows storage
2. **Browser restrictions** - Some browsers limit extension storage

---

## Sources

- [Greasyfork - Twitter Media Downloader](https://greasyfork.org/en/scripts/12345-twitter-media-downloader)
- [Violentmonkey - GM_download API](https://violentmonkey.github.io/api/gm/#gm_download)
- [MDN - MutationObserver](https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver)
- [Twitter API Documentation](https://developer.twitter.com/en/docs/twitter-api)

---

**Last Updated:** 2026-02-11