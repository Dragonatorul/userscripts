# Grok Imagine Downloader - Technical Documentation

> **âš ï¸ AI-Generated Content Disclaimer**
>
> This document was generated by Claude Code AI following system research and online web searches. While efforts have been made to ensure accuracy, AI-generated content can contain errors or outdated information. Please verify critical details and test recommendations in a safe environment before applying them to production systems.

---

## Overview

The Grok Imagine Downloader is a userscript that enables bulk downloading of AI-generated images and videos from Grok's "Image Favorites" page and single post pages. It intercepts API responses to capture media metadata, injects download buttons onto image cards, and provides a floating "Download All" button with settings panel for maintenance.

**Script:** `grok-bulk-image-downloader.user.js`
**Version:** 2026-02-11
**Author:** Mykyta Shcherbyna (modified by Dragonator)
**Source:** [Greasyfork #556188](https://greasyfork.org/en/scripts/556188)

---

## Table of Contents

- [How It Works](#how-it-works)
- [Architecture](#architecture)
- [Technical Details](#technical-details)
- [New Features (v2026-02-11)](#new-features-v2026-02-11)
- [Security Analysis](#security-analysis)
- [Data Flow](#data-flow)
- [Code Walkthrough](#code-walkthrough)

---

## How It Works

The script operates in three phases:

### Phase 1: API Interception

The script runs at `document-start` to override the browser's `fetch()` function before Grok's JavaScript loads:

```javascript
const origFetch = unsafeWindow.fetch;
unsafeWindow.fetch = async function (url, options) {
    const resp = await origFetch(url, options);  // Call original fetch

    if (url.includes('/rest/media/post/list')) {
        const clone = resp.clone();
        const data = await clone.json();
        processApiData(data);  // Extract media info
    }

    return resp;  // Return unmodified response
};
```

**Why this is necessary:**

Grok is a single-page application (SPA). The image gallery loads via JavaScript API calls, not traditional page loads. The script "listens" to these API responses to discover what images exist and their download URLs.

### Phase 2: Media Database & UI Enhancement

Captured media metadata is stored in a local JavaScript `Map` with deduplication:

```javascript
const mediaDatabase = new Map();

// Structure:
{
  postId: {
    id: "abc12345-1234-5678-9abc-def012345678",
    object: [
      { id, url, createTime, modelName, prompt, filename },
      { id, url, createTime, modelName, prompt, filename },
      // ... more media items
    ]
  }
}
```

**New in v2026-02-11:** Automatic deduplication after each API processing, download history persistence, and settings panel for maintenance.

### Phase 3: UI Injection & Bulk Downloads

A `MutationObserver` watches for new image cards in the DOM and injects download buttons. A floating "Download All" button provides bulk download functionality with progress tracking and cancel support:

```javascript
const observer = new MutationObserver(debouncedProcessCards);
observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: true,
    attributeFilter: ['src', 'data-src', 'data-lazy', 'poster']
});
```

**Why this is necessary:**

Grok is a single-page application (SPA). The image gallery loads via JavaScript API calls, not traditional page loads. The script "listens" to these API responses to discover what images exist and their download URLs.

### Phase 2: Media Database

Captured media metadata is stored in a local JavaScript `Map`:

```javascript
const mediaDatabase = new Map();

// Structure:
{
  postId: {
    id: "abc12345-1234-5678-9abc-def012345678",
    object: [
      { id, url, createTime, modelName, prompt, filename },
      { id, url, createTime, modelName, prompt, filename },
      // ... more media items
    ]
  }
}
```

### Phase 3: UI Injection

A `MutationObserver` watches for new image cards in the DOM and injects download buttons:

```javascript
const observer = new MutationObserver(debouncedProcessCards);
observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: true,
    attributeFilter: ['src', 'data-src', 'data-lazy', 'poster']
});
```

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GROK WEBSITE (SPA)                          â”‚
â”‚  (Favorites, Single Post, Prompt, or More Like This pages)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Page Type Detection                                              â”‚
â”‚  â†’ PROMPT: Session tracking + JSON export                       â”‚
â”‚  â†’ FAVORITES: Bulk API aggregation                              â”‚
â”‚  â†’ SINGLE_POST: DOM + API hybrid extraction                     â”‚
â”‚  â†’ MORE_LIKE_THIS: Generation continuation                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Interception (/rest/media/post/list, /create)               â”‚
â”‚  â†’ Intercepts fetch() calls before Grok's JS loads              â”‚
â”‚  â†’ Extracts media metadata, URLs, prompts, timestamps           â”‚
â”‚  â†’ Populates mediaDatabase with deduplication                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DOM Extraction (Single post & Prompt pages)                     â”‚
â”‚  â†’ Single posts: Extract all tab media (Video + Image)          â”‚
â”‚  â†’ Prompt pages: Extract from React fiber + data URIs           â”‚
â”‚  â†’ Adds to aggregated media collections                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MutationObserver + Debounced Processing                         â”‚
â”‚  â†’ Watches for new image/video cards in DOM                      â”‚
â”‚  â†’ Matches cards to mediaDatabase via UUID extraction           â”‚
â”‚  â†’ Injects download buttons with hover effects                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt Session Tracking (Ephemeral)                             â”‚
â”‚  â†’ Tracks generated images in memory                            â”‚
â”‚  â†’ JSON export capability                                       â”‚
â”‚  â†’ Automatic prompt capture from UI                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼ (user interaction)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Floating UI Controls                                           â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ â¬‡ Download All  â”‚    â”‚ âš™ï¸ Settings  â”‚                         â”‚
â”‚  â”‚     (18 items)   â”‚    â”‚             â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Settings Panel                           â”‚ â”‚
â”‚  â”‚  ðŸ“ Entries: 5   ðŸ–¼ï¸ Images: 13   ðŸŽ¬ Videos: 5               â”‚ â”‚
â”‚  â”‚  ðŸ“¦ Total items: 18   âš ï¸ Duplicates: 0   âœ… Downloaded: 3     â”‚ â”‚
â”‚  â”‚  ðŸªµ Log Level: INFO   [ðŸ”„ Remove Duplicates] [ðŸ—‘ï¸ Clear Session] â”‚ â”‚
â”‚  â”‚  [âš ï¸ Clear History] [ðŸ“¤ Export JSON]                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GM_download() with Persistence                                 â”‚
â”‚                                                                 â”‚
â”‚  Downloads from:                                                â”‚
â”‚  â€¢ assets.grok.com (legacy)                                     â”‚
â”‚  â€¢ imagine-public.x.ai (primary)                                â”‚
â”‚                                                                 â”‚
â”‚  Saves as: grok_{timestamp}_{id}_{model}_{prompt}.{ext}         â”‚
â”‚  Tracks: download history + prompt session data                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Advanced Logging System                                        â”‚
â”‚  â†’ Color-coded console output with timestamps                   â”‚
â”‚  â†’ Configurable verbosity (OFF to DEBUG)                        â”‚
â”‚  â†’ Persistent log level settings                               â”‚
â”‚  â†’ Grouped logging for complex operations                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Technical Details

### Permissions Explained

| Permission | Purpose | Why Required |
|------------|---------|--------------|
| `GM_download` | Download files directly | Enables bulk downloads without browser prompts |
| `unsafeWindow` | Access page's JS context | Required for fetch interception |
| `GM_xmlhttpRequest` | Cross-origin requests | **Declared but unused** - could be removed |
| `GM_getValue` | Read stored preferences | Load download history, log level, and media database |
| `GM_setValue` | Store user preferences | Save download history, log level, and media database persistently |
| `@run-at document-start` | Run before page loads | Must override `fetch()` before Grok's code runs |
| `@connect assets.grok.com` | Whitelist domain | Allow downloads from Grok's legacy CDN |
| `@connect imagine-public.x.ai` | Whitelist domain | Allow downloads from X's image CDN |

### Advanced Logging System

The script includes a sophisticated logging system for debugging and monitoring:

```javascript
const LOG_LEVEL = {
    OFF: 0, ERROR: 1, WARN: 2, INFO: 3, DEBUG: 4
};
```

- **Color-coded output**: Different colors for ERROR (red), WARN (orange), INFO (blue), DEBUG (green)
- **Timestamped entries**: All messages include ISO timestamps
- **Persistent configuration**: Log level saved using `GM_getValue`
- **Grouped logging**: Collapsible console groups for related operations
- **Settings panel integration**: Users can adjust log verbosity

### Page Type Detection

Automatic detection of different Grok Imagine page types:

```javascript
const PAGE_TYPE = {
    PROMPT: 'prompt',           // /imagine - main prompt page
    MORE_LIKE_THIS: 'more',     // /imagine/more/{id} - continuation
    FAVORITES: 'favorites',     // /imagine/favorites
    SINGLE_POST: 'single_post', // /imagine/post/{id}
    OTHER: 'other'
};
```

Each page type triggers different behavior:
- **Prompt pages**: Session-based tracking with JSON export
- **Favorites**: Bulk aggregation from API responses
- **Single posts**: DOM extraction with tab aggregation
- **More like this**: Generation continuation handling

### API Response Structure

The `/rest/media/post/list` endpoint returns JSON like:

```json
{
  "posts": [
    {
      "id": "abc12345-1234-5678-9abc-def012345678",
      "mediaUrl": "https://assets.grok.com/.../image.jpg",
      "hdMediaUrl": "https://assets.grok.com/.../image_hd.mp4",
      "mediaType": "MEDIA_POST_TYPE_IMAGE",
      "mimeType": "image/jpeg",
      "createTime": "2025-01-15T14:30:00Z",
      "modelName": "aurora",
      "originalPrompt": "a cat wearing a tiny hat",
      "childPosts": [
        {
          "id": "child-uuid-...",
          "mediaUrl": "https://assets.grok.com/.../variation1.jpg",
          ...
        }
      ]
    }
  ]
}
```

### Post ID Extraction

The script matches image cards to database entries via UUID extraction:

```javascript
function extractPostIdFromUrl(url) {
    // URL: https://assets.grok.com/abc12345-1234-5678-9abc-def012345678/image.jpg
    const matches = [...url.matchAll(
        /[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}/g
    )];
    return matches.length > 0 ? matches[matches.length - 1][0] : null;
}
```

### Unified Filename Generation

The script uses a consistent naming scheme across all download types:

```javascript
function buildUnifiedFilename({ time, id, model, prompt, ext }) {
    const parts = ['grok', time || 'unknown', id || 'unknown'];
    if (model) parts.push(model);
    if (prompt) parts.push(prompt);
    return `${parts.join('_')}.${ext}`;
}
```

**Example filenames:**
- `grok_2025-01-15T14-30-00_abc12345-1234-5678-9abc-def012345678_aurora_a_cat_wearing_a_tiny_hat.jpg`
- `grok_2025-01-15T14-30-00_def56789-5678-9abc-def0-123456789012__no_prompt.mp4`

**Features:**
- **Cross-platform safe**: Sanitizes special characters for Windows/macOS/Linux
- **Truncated prompts**: Limits prompt length to 100 characters to prevent filesystem issues
- **Extension detection**: Automatic detection from MIME types (`video/mp4`, `image/jpeg`, `image/png`)
- **Fallback handling**: Graceful degradation when metadata is missing

### DOM Selectors

```javascript
// Card container (Tailwind CSS classes)
const CARD_SELECTOR = '.group\\/media-post-masonry-card:not([data-downloader-added])';

// Button container within each card
const BUTTON_CONTAINER_SELECTOR = '.absolute.bottom-2.right-2';

// Button styling (matches Grok's design)
const BUTTON_CLASSES = 'inline-flex items-center justify-center gap-2 ...';
---

## New Features (v2026-02-11)

### Advanced Logging System

A configurable logging system with multiple verbosity levels:

- **Log Levels**: OFF, ERROR, WARN, INFO, DEBUG with color-coded console output
- **Persistent Settings**: Log level saved across sessions using `GM_getValue`
- **Timestamped Entries**: All log messages include timestamps for debugging
- **Grouped Logging**: Support for collapsible console groups for related operations
- **Settings Integration**: Log level can be changed via the settings panel

### Page Type Detection and Specialized Handling

Enhanced support for different Grok Imagine page types:

- **Prompt Pages** (`/imagine`): Session-based tracking with ephemeral storage
- **More Like This** (`/imagine/more/{id}`): Generation continuation pages
- **Favorites** (`/imagine/favorites`): Bulk download from all favorited posts
- **Single Post** (`/imagine/post/{id}`): Aggregated media from both Video/Image tabs
- **Dynamic Detection**: Automatic behavior adaptation based on current page type

### Prompt Page Session Tracking

Ephemeral tracking system for AI-generated images on prompt pages:

- **Session-Based Storage**: In-memory tracking that resets on page reload
- **JSON Export**: Ability to export session data including all prompts and image metadata
- **Download History**: Tracks which images have been downloaded within the session
- **Automatic Prompt Capture**: Extracts current prompt from input field or sticky chips
- **Unified Filename**: Consistent naming scheme for prompt-generated images

### Floating "Download All" Button

A persistent floating button appears on all `/imagine` pages that allows bulk downloading of all undownloaded media:

- **Smart aggregation**: On favorites pages, downloads from all posts. On single post pages, downloads all media from the current post (including both Video and Image tabs)
- **Progress tracking**: Shows "â¹ Cancel (0/18)" with live updates
- **Cancel support**: Click during download to cancel remaining items
- **Session persistence**: Tracks downloaded items across page reloads

### Settings Panel

Accessible via a gear icon (âš™ï¸) button, provides database maintenance tools:

- **Statistics display**: Real-time counts of entries, images, videos, duplicates, and downloaded items
- **Remove Duplicates**: Automatically finds and removes duplicate media entries
- **Clear Session Data**: Resets the in-memory media database (useful for troubleshooting)
- **Clear Download History**: Resets the persistent download tracking
- **Log Level Control**: Adjust logging verbosity for debugging

### Single Post Page Support

Enhanced support for individual post URLs (`/imagine/post/{uuid}`):

- **Tab aggregation**: Media from both "Video" and "Image" tabs are combined under one post ID
- **DOM extraction**: Directly extracts media URLs from the page when API data is incomplete
- **URL watching**: Automatically rescans when switching between Video/Image tabs
- **Root post tracking**: Maintains consistent aggregation when navigating between tabs

### Download History Persistence

- **Cross-session tracking**: Remembers which items have been downloaded using `GM_getValue`/`GM_setValue`
- **Smart filtering**: "Download All" button only shows undownloaded items
- **Duplicate prevention**: Won't redownload items marked as completed

### Automatic Maintenance

- **Deduplication**: Runs automatically after each API data processing
- **Database statistics**: Available via console logging and settings panel
- **Memory management**: Clears session data on page navigation away from `/imagine` pages

### React Fiber ID Extraction

Advanced fallback method for identifying images on prompt pages:

- **React Component Traversal**: Searches React fiber tree for UUID identifiers
- **Data URI Resolution**: Converts base64 data URIs to CDN URLs using extracted IDs
- **User ID Detection**: Extracts user ID from cookies or existing CDN URLs for URL construction

### Unified Filename Generation

Consistent naming scheme across all download types:

```
grok_{timestamp}_{id}_{model}_{prompt}.{ext}
```

- **Cross-platform safe**: Sanitizes special characters for Windows/macOS/Linux compatibility
- **Truncated prompts**: Limits prompt length to prevent filesystem issues
- **Extension detection**: Automatic detection from MIME types or URL patterns

---

## Security Analysis

### Risk Assessment

| Concern | Severity | Details |
|---------|----------|---------|
| `unsafeWindow` usage | âš ï¸ Medium | Required for fetch interception; trust in author needed |
| Unused `GM_xmlhttpRequest` | ðŸ”¶ Low | Permission declared but not used in code |
| Fetch override | âš ï¸ Medium | Only intercepts specific Grok API; read-only |
| `@run-at document-start` | ðŸ”¶ Low | Standard requirement for API interception |

### What the Script Does NOT Do

- âŒ Send data to external servers
- âŒ Access cookies or authentication tokens
- âŒ Modify API requests (only reads responses)
- âŒ Store data in localStorage/sessionStorage
- âŒ Make outbound network requests (despite having permission)

### What It DOES Access

- âœ… Intercepts `/rest/media/post/list` API responses (read-only)
- âœ… Downloads from `assets.grok.com` and `imagine-public.x.ai`
- âœ… Modifies DOM to add download buttons and floating UI elements
- âœ… Uses `unsafeWindow` to access page's `fetch` function
- âœ… Stores download history locally using `GM_getValue`/`GM_setValue`
- âœ… Tracks session data in memory (cleared on page reload)

### Trust Considerations

Since this script uses `unsafeWindow` and intercepts network requests:

1. **Review updates carefully** - auto-updates could introduce malicious code
2. **Pin to specific version** if concerned about updates
3. **Monitor browser console** for unexpected network activity

---

## Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Grok Website                            â”‚
â”‚  (Favorites, Single Post, Prompt, or More Like This pages)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Page Type Detection                                              â”‚
â”‚  â†’ PROMPT: Enable session tracking + JSON export                â”‚
â”‚  â†’ FAVORITES: Enable bulk aggregation                           â”‚
â”‚  â†’ SINGLE_POST: Enable DOM extraction + tab aggregation         â”‚
â”‚  â†’ MORE_LIKE_THIS: Enable continuation handling                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  fetch('/rest/media/post/list') or fetch('/create')              â”‚
â”‚  â†’ API responses contain posts, mediaUrls, prompts, etc.         â”‚
â”‚  â†’ POST/CREATE responses trigger prompt session updates          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼ (intercepted by script)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Processing                                                   â”‚
â”‚  â†’ processApiData() for favorites/single posts                   â”‚
â”‚  â†’ processCreatedPost() for prompt page generation               â”‚
â”‚  â†’ Populates mediaDatabase or promptSessionData                  â”‚
â”‚  â†’ Automatic deduplication after each processing                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DOM Extraction (Single post & Prompt pages)                     â”‚
â”‚  â†’ Single posts: extractImageUrlsFromDOM() + videos             â”‚
â”‚  â†’ Prompt pages: extractPromptPageImages() + React fiber        â”‚
â”‚  â†’ Adds to media collections or prompt session                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MutationObserver detects new image/video cards                 â”‚
â”‚  â†’ processCards() for favorites/single posts                     â”‚
â”‚  â†’ processPromptPageImages() for prompt pages                    â”‚
â”‚  â†’ Matches via UUID extraction or React fiber traversal         â”‚
â”‚  â†’ Injects download buttons (persistent or hover-based)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt Session Tracking (Ephemeral for /imagine pages)          â”‚
â”‚  â†’ Tracks generated images in promptSessionData Map             â”‚
â”‚  â†’ Automatic prompt capture from input/DOM                      â”‚
â”‚  â†’ JSON export capability for session analysis                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼ (user interaction)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Floating "Download All" Button                                 â”‚
â”‚  â†’ getUndownloadedItems() filters by download history           â”‚
â”‚  â†’ startDownloadAll() with progress, cancel, & persistence      â”‚
â”‚  â†’ Supports both mediaDatabase and promptSessionData            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Settings Panel (âš™ï¸)                                            â”‚
â”‚  â†’ getDatabaseStats() shows real-time statistics                â”‚
â”‚  â†’ deduplicateDatabase() removes duplicates                     â”‚
â”‚  â†’ clearMediaDatabase() / clearDownloadHistory() maintenance    â”‚
â”‚  â†’ Logger.setLevel() for debugging control                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GM_download() with Advanced Features                           â”‚
â”‚  â†’ Downloads from assets.grok.com / imagine-public.x.ai         â”‚
â”‚  â†’ Handles data URI resolution for prompt images                â”‚
â”‚  â†’ Uses buildUnifiedFilename() for consistent naming            â”‚
â”‚  â†’ Tracks completion in persistent + session history            â”‚
â”‚  â†’ Supports cancel operations during bulk downloads             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Advanced Logging System                                        â”‚
â”‚  â†’ Logger.info/warn/error/debug() with timestamps               â”‚
â”‚  â†’ Color-coded console output for easy reading                  â”‚
â”‚  â†’ Configurable verbosity levels                                â”‚
â”‚  â†’ Persistent log level settings                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Code Walkthrough

### Entry Point

```javascript
(function () {
    'use strict';

    // Constants for DOM selectors
    const CARD_SELECTOR = '...';
    const BUTTON_CONTAINER_SELECTOR = '...';

    // In-memory storage for media metadata
    const mediaDatabase = new Map();

    // Override fetch before page loads
    const origFetch = unsafeWindow.fetch;
    unsafeWindow.fetch = async function (url, options) { ... };

    // Watch for new cards
    const observer = new MutationObserver(debouncedProcessCards);
    observer.observe(document.body, { ... });

    // Initial scan
    debouncedProcessCards();
})();
```

### Key Functions

| Function | Purpose |
|----------|---------|
| `Logger.*()` | Advanced logging system with levels, colors, and timestamps |
| `detectPageType()` | Identifies current page type for behavior adaptation |
| `loadDownloadedIds()` / `saveDownloadedIds()` | Persistent download tracking |
| `clearMediaDatabase()` / `clearDownloadHistory()` | Maintenance functions |
| `getDatabaseStats()` / `deduplicateDatabase()` | Database management |
| `extractPostIdFromUrl(url)` | Extract UUID from image URL |
| `sanitizeForFilename(str)` | Remove invalid filename characters |
| `buildUnifiedFilename()` | Generate consistent filenames across all types |
| `downloadFile(item, onComplete)` | Trigger GM_download with completion callback |
| `startDownloads(media, postId, button)` | Orchestrate bulk download for individual cards |
| `startDownloadAll()` | Handle floating "Download All" button with progress & cancel |
| `createMediaObject(source, fallbackParent)` | Normalize API response to media object |
| `processApiData(apiData)` | Parse API response, populate database with deduplication |
| `processCards()` | Scan DOM, inject download buttons on cards |
| `getUndownloadedItems()` | Filter media database by download history |
| `updateDownloadAllButton()` | Update floating button text based on available items |
| `deduplicateDatabase()` | Remove duplicate entries from media database |
| `loadSinglePostPageData()` | Extract media directly from DOM on single post pages |
| `createSettingsPanel()` | Initialize settings panel UI with log level control |
| `updateSettingsStats()` | Refresh statistics display in settings panel |
| `processCreatedPost(post)` | Handle newly created posts from API interception |
| `processPromptPageImages()` | DOM-based extraction for prompt pages |
| `extractIdFromReactFiber(element)` | Advanced React component ID extraction |
| `getUserIdFromPage()` | Extract user ID for URL construction |
| `resolvePromptImageUrl()` | Convert data URIs to CDN URLs |
| `exportPromptSessionAsJSON()` | Export session data as JSON file |
| `addDownloadButtonToPromptImage()` | Add hover-based download buttons to prompt images |

### Error Handling

```javascript
// API interception errors
try {
    const clone = resp.clone();
    const data = await clone.json();
    processApiData(data);
} catch (e) {
    console.error('API intercept error:', e);
}

// Download completion tracking
const onComplete = () => {
    completed++;
    button.textContent = `${completed}/${total}`;
    if ((completed + failed) === total) {
        button.textContent = failed > 0 ? 'ERR' : 'OK!';
    }
};
```

---

## Comparison with Other Exporters

| Feature | RevivalStack | Enhanced Grok Export | **Grok Image Downloader** |
|---------|--------------|---------------------|---------------------------|
| **Type** | Chat export | Chat export | **Media download** |
| **Permissions** | Low | None | **Medium** |
| **API interception** | No | No | **Yes** |
| **External connections** | None | Twitter intent | **Grok CDN + X CDN** |
| **Run timing** | document-idle | document-idle | **document-start** |
| **Page support** | Chat only | Chat only | **All Imagine pages** |
| **Bulk downloads** | No | No | **Yes with progress** |
| **Download history** | No | No | **Persistent tracking** |
| **Settings panel** | No | No | **Yes with maintenance** |
| **Session tracking** | No | No | **JSON export for prompts** |
| **Advanced logging** | No | No | **Configurable levels** |
| **Deduplication** | No | No | **Automatic** |
| **Cancel operations** | No | No | **Yes** |
| **Unified filenames** | No | No | **Cross-platform safe** |

---

## Troubleshooting

### Download Button Not Appearing

1. **Check if API was intercepted** - Open browser console, look for media database entries
2. **Verify card selector** - Grok may have updated their CSS classes
3. **Wait for lazy loading** - Images may not be in DOM yet

### Downloads Failing

1. **Check CDN connectivity** - Ensure `assets.grok.com` is accessible
2. **Verify permissions** - `GM_download` must be granted
3. **Check filename length** - Very long prompts may cause issues

### Script Not Loading

1. **Check `@run-at document-start`** - Must run before page JS
2. **Verify `@match` pattern** - Must match current URL
3. **Check `unsafeWindow` access** - Some userscript managers restrict this

---

## Sources

- [Greasyfork - Grok Imagine Downloader](https://greasyfork.org/en/scripts/556188)
- [Violentmonkey - GM_download API](https://violentmonkey.github.io/api/gm/#gm_download)
- [MDN - MutationObserver](https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver)
- [MDN - Fetch API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)

---

**Last Updated:** 2026-02-11 (Updated with advanced features documentation)
